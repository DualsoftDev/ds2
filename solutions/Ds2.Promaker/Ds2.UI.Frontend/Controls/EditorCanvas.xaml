<UserControl x:Class="Ds2.UI.Frontend.Controls.EditorCanvas"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:Ds2.UI.Frontend.Converters"
             xmlns:vm="clr-namespace:Ds2.UI.Frontend.ViewModels">
    <UserControl.Resources>
        <conv:EntityTypeToBrushConverter x:Key="TypeToBrush"/>
        <conv:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <conv:InvCountToVisibilityConverter x:Key="InvCountToVis"/>
        <conv:PositiveIntToVisibilityConverter x:Key="PositiveIntToVis"/>
        <conv:ArrowTypeToColorConverter x:Key="ArrowTypeToColor"/>
        <conv:ArrowTypeToDashConverter x:Key="ArrowTypeToDash"/>
    </UserControl.Resources>

    <Grid x:Name="RootGrid" ClipToBounds="True"
          Background="Transparent"
          MouseWheel="OnMouseWheel"
          MouseDown="OnMouseDown"
          MouseMove="OnMouseMove"
          MouseUp="OnMouseUp">
        <Grid.ContextMenu>
            <ContextMenu>
                <MenuItem Header="Add Work" Click="AddWork_Click"/>
                <MenuItem Header="Add Call" Click="AddCall_Click"/>
                <Separator/>
                <MenuItem Header="Copy" Command="{Binding CopySelectedCommand}"/>
                <MenuItem Header="Paste" Command="{Binding PasteCopiedCommand}"/>
                <Separator/>
                <MenuItem Header="Connect Arrow" Click="StartConnect_Click"/>
            </ContextMenu>
        </Grid.ContextMenu>

        <!-- Viewport with zoom/pan transforms -->
        <Canvas x:Name="ViewportCanvas" ClipToBounds="True">
            <Border x:Name="SlideContainer"
                    Width="3000" Height="2000"
                    Background="{DynamicResource CanvasBackgroundBrush}">
                <Border.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1"/>
                        <TranslateTransform x:Name="PanTransform" X="0" Y="0"/>
                    </TransformGroup>
                </Border.RenderTransform>

                <!-- Node layer -->
                <Canvas x:Name="MainCanvas" Width="3000" Height="2000">
                    <!-- Arrow layer (below nodes) -->
                    <ItemsControl ItemsSource="{Binding CanvasArrows}" Panel.ZIndex="20">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate><Canvas/></ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type vm:ArrowNode}">
                                <Canvas>
                                    <Path Data="{Binding PathGeometry}"
                                          Stroke="{Binding ArrowType, Converter={StaticResource ArrowTypeToColor}}"
                                          StrokeThickness="2.5"
                                          StrokeDashArray="{Binding ArrowType, Converter={StaticResource ArrowTypeToDash}}"
                                          StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                                    <Path Data="{Binding HeadGeometry}"
                                          Fill="{Binding ArrowType, Converter={StaticResource ArrowTypeToColor}}"
                                          Stroke="{Binding ArrowType, Converter={StaticResource ArrowTypeToColor}}"
                                          StrokeThickness="2.5"
                                          StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                                    <Path Data="{Binding PathGeometry}"
                                          Stroke="Transparent" StrokeThickness="20"
                                          Tag="{Binding Id}"
                                          MouseLeftButtonDown="Arrow_MouseDown"/>
                                    <Ellipse Width="10"
                                             Height="10"
                                             Fill="{DynamicResource AccentBrush}"
                                             Stroke="{DynamicResource PrimaryTextBrush}"
                                             StrokeThickness="1"
                                             Cursor="Cross"
                                             Canvas.Left="{Binding StartX}"
                                             Canvas.Top="{Binding StartY}"
                                             Tag="{Binding Id}"
                                             Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}"
                                             MouseLeftButtonDown="ArrowStartHandle_MouseLeftButtonDown">
                                        <Ellipse.RenderTransform>
                                            <TranslateTransform X="-5" Y="-5"/>
                                        </Ellipse.RenderTransform>
                                    </Ellipse>
                                    <Ellipse Width="10"
                                             Height="10"
                                             Fill="{DynamicResource AccentHoverBrush}"
                                             Stroke="{DynamicResource PrimaryTextBrush}"
                                             StrokeThickness="1"
                                             Cursor="Cross"
                                             Canvas.Left="{Binding EndX}"
                                             Canvas.Top="{Binding EndY}"
                                             Tag="{Binding Id}"
                                             Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}"
                                             MouseLeftButtonDown="ArrowEndHandle_MouseLeftButtonDown">
                                        <Ellipse.RenderTransform>
                                            <TranslateTransform X="-5" Y="-5"/>
                                        </Ellipse.RenderTransform>
                                    </Ellipse>
                                </Canvas>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Node layer -->
                    <ItemsControl x:Name="NodesHost" ItemsSource="{Binding CanvasNodes}" Panel.ZIndex="10">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style TargetType="ContentPresenter">
                                <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type vm:EntityNode}">
                                <Grid>
                                    <Border x:Name="NodeBorder"
                                            Width="{Binding Width}" Height="{Binding Height}"
                                            Background="{DynamicResource TertiaryBackgroundBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1" CornerRadius="3" Cursor="Hand"
                                            Tag="{Binding Id}">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.5"
                                                              Color="{DynamicResource ShadowColor}"/>
                                        </Border.Effect>
                                        <Viewbox Stretch="Uniform" StretchDirection="DownOnly" Margin="8">
                                            <TextBlock Text="{Binding Name}"
                                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                                       FontSize="14" FontWeight="Bold"
                                                       TextWrapping="Wrap" TextAlignment="Center"
                                            MaxWidth="150"/>
                                        </Viewbox>
                                    </Border>
                                    <Border HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Margin="0,-8,-8,0"
                                            Padding="5,0"
                                            MinWidth="18"
                                            Height="18"
                                            CornerRadius="9"
                                            Background="{DynamicResource AccentBrush}"
                                            Visibility="{Binding SelectionOrder, Converter={StaticResource PositiveIntToVis}}">
                                        <TextBlock Text="{Binding SelectionOrder}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   Foreground="White"
                                                   FontSize="10"
                                                   FontWeight="Bold"/>
                                    </Border>
                                </Grid>
                                <DataTemplate.Triggers>
                                    <!-- Work: orange border -->
                                    <DataTrigger Binding="{Binding EntityType}" Value="Work">
                                        <Setter TargetName="NodeBorder" Property="Background"
                                                Value="{DynamicResource NodeWorkBackgroundBrush}"/>
                                        <Setter TargetName="NodeBorder" Property="BorderBrush"
                                                Value="{DynamicResource OrangeAccentBrush}"/>
                                    </DataTrigger>
                                    <!-- Call: blue border, rounded -->
                                    <DataTrigger Binding="{Binding EntityType}" Value="Call">
                                        <Setter TargetName="NodeBorder" Property="Background"
                                                Value="{DynamicResource NodeCallBackgroundBrush}"/>
                                        <Setter TargetName="NodeBorder" Property="BorderBrush"
                                                Value="{DynamicResource AccentBrush}"/>
                                        <Setter TargetName="NodeBorder" Property="CornerRadius" Value="20"/>
                                    </DataTrigger>
                                    <!-- Selected: glow effect -->
                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                        <Setter TargetName="NodeBorder" Property="BorderBrush"
                                                Value="{DynamicResource AccentHoverBrush}"/>
                                        <Setter TargetName="NodeBorder" Property="BorderThickness" Value="3"/>
                                        <Setter TargetName="NodeBorder" Property="Margin" Value="-2"/>
                                        <Setter TargetName="NodeBorder" Property="Effect">
                                            <Setter.Value>
                                                <DropShadowEffect BlurRadius="20" ShadowDepth="0" Opacity="0.8"
                                                                  Color="{DynamicResource AccentHoverColor}"/>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                    <!-- Selected Work -->
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsSelected}" Value="True"/>
                                            <Condition Binding="{Binding EntityType}" Value="Work"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter TargetName="NodeBorder" Property="Background"
                                                Value="{DynamicResource NodeWorkSelectedBackgroundBrush}"/>
                                    </MultiDataTrigger>
                                    <!-- Selected Call -->
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsSelected}" Value="True"/>
                                            <Condition Binding="{Binding EntityType}" Value="Call"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter TargetName="NodeBorder" Property="Background"
                                                Value="{DynamicResource NodeCallSelectedBackgroundBrush}"/>
                                        <Setter TargetName="NodeBorder" Property="CornerRadius" Value="20"/>
                                    </MultiDataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Connect mode preview line -->
                    <Line x:Name="ConnectPreview"
                          Stroke="{DynamicResource AccentBrush}" StrokeThickness="2"
                          StrokeDashArray="4,2" Visibility="Collapsed"/>

                    <!-- Selection rectangle for multi-select -->
                    <Rectangle x:Name="SelectionRect"
                               Stroke="{DynamicResource AccentBrush}"
                               StrokeThickness="1" StrokeDashArray="4,2"
                               Fill="#20007ACC" Visibility="Collapsed"/>
                </Canvas>
            </Border>
        </Canvas>

        <!-- Empty state (no nodes) -->
        <TextBlock Text="Right-click to add nodes"
                   HorizontalAlignment="Center" VerticalAlignment="Center"
                   FontSize="14" Foreground="{DynamicResource SecondaryTextBrush}"
                   IsHitTestVisible="False"
                   Visibility="{Binding CanvasNodes.Count, Converter={StaticResource InvCountToVis}}"/>

        <!-- Zoom indicator (bottom-right) -->
        <Border HorizontalAlignment="Right" VerticalAlignment="Bottom"
                Margin="10" Padding="8,4"
                Background="{DynamicResource TertiaryBackgroundBrush}"
                CornerRadius="3" Opacity="0.9">
            <TextBlock x:Name="ZoomText" Text="100%"
                       Foreground="{DynamicResource PrimaryTextBrush}" FontSize="11"/>
        </Border>

        <!-- Mini toolbar (top-right) -->
        <Border HorizontalAlignment="Right" VerticalAlignment="Top"
                Margin="10" Padding="4"
                Background="{DynamicResource TertiaryBackgroundBrush}"
                CornerRadius="3">
            <StackPanel Orientation="Horizontal">
                <Button Style="{StaticResource RibbonButton}" Width="28" Height="28"
                        ToolTip="Fit to view (Home)" Click="OnFitToView">
                    <Path Data="M4,4H8V8H4V4M10,4H14V8H10V4M16,4H20V8H16V4M4,10H8V14H4V10M4,16H8V20H4V16M10,16H14V20H10V16M16,16H20V20H16V16"
                          Fill="{DynamicResource SecondaryTextBrush}" Width="14" Height="14" Stretch="Uniform"/>
                </Button>
                <Button Style="{StaticResource RibbonButton}" Width="28" Height="28"
                        ToolTip="Zoom in (+)" Click="OnZoomIn">
                    <Path Data="M15.5,14L20.5,19L19,20.5L14,15.5V14.71L13.73,14.43C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.43,13.73L14.71,14H15.5M9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14M12,10H10V12H9V10H7V9H9V7H10V9H12V10Z"
                          Fill="{DynamicResource SecondaryTextBrush}" Width="14" Height="14" Stretch="Uniform"/>
                </Button>
                <Button Style="{StaticResource RibbonButton}" Width="28" Height="28"
                        ToolTip="Zoom out (-)" Click="OnZoomOut">
                    <Path Data="M15.5,14L20.5,19L19,20.5L14,15.5V14.71L13.73,14.43C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.43,13.73L14.71,14H15.5M9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14M7,9H12V10H7V9Z"
                          Fill="{DynamicResource SecondaryTextBrush}" Width="14" Height="14" Stretch="Uniform"/>
                </Button>
                <Button Style="{StaticResource RibbonButton}" Width="28" Height="28"
                        ToolTip="Reset zoom (Ctrl+0)" Click="OnResetZoom">
                    <Path Data="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                          Fill="{DynamicResource SecondaryTextBrush}" Width="14" Height="14" Stretch="Uniform"/>
                </Button>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
